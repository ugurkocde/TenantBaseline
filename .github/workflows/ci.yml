name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: PSScriptAnalyzer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path ./src/TenantBaseline -Recurse -ExcludeRule PSUseShouldProcessForStateChangingFunctions
          $results | Format-Table -AutoSize
          if ($results | Where-Object Severity -eq 'Error') {
              throw 'PSScriptAnalyzer found errors.'
          }

  test-ps7:
    name: Pester (PowerShell 7)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -Scope CurrentUser
          Install-Module -Name Microsoft.Graph.Authentication -MinimumVersion 2.0.0 -Force -Scope CurrentUser

      - name: Run Pester tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './tests/Unit'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'testResults.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          $config.Output.Verbosity = 'Detailed'
          Invoke-Pester -Configuration $config

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-ps7
          path: testResults.xml

  module-import:
    name: Module import test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Microsoft.Graph.Authentication -MinimumVersion 2.0.0 -Force -Scope CurrentUser

      - name: Test module import
        shell: pwsh
        run: |
          Import-Module ./src/TenantBaseline/TenantBaseline.psd1 -Force
          $commands = Get-Command -Module TenantBaseline
          Write-Host "Exported commands: $($commands.Count)"
          $commands | Format-Table Name, CommandType -AutoSize
          if ($commands.Count -ne 26) {
              throw "Expected 26 exported commands, got $($commands.Count)"
          }
